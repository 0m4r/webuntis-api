name: Version (Nx Release)

on:
  workflow_dispatch:
    inputs:
      specifier:
        description: "Semver specifier (e.g. patch, minor, major, prepatch, preminor, premajor, prerelease, or explicit version)"
        required: true
        default: "patch"
      preid:
        description: "Prerelease identifier (used when specifier is a prerelease)"
        required: false
        default: ""

permissions:
  contents: write
  pull-requests: write

jobs:
  version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://npm.pkg.github.com
          cache: yarn

      - name: Install dependencies
        run: yarn install --immutable

      - name: Configure git identity
        env:
          GIT_USER_NAME: ${{ secrets.GIT_USER_NAME }}
          GIT_USER_EMAIL: ${{ secrets.GIT_USER_EMAIL }}
        run: |
          git config user.name "${GIT_USER_NAME:-github-actions[bot]}"
          git config user.email "${GIT_USER_EMAIL:-41898282+github-actions[bot]@users.noreply.github.com}"

      - name: Run Nx release version
        env:
          NX_DAEMON: "false"
        run: |
          SPEC="${{ inputs.specifier }}"
          PREID="${{ inputs.preid }}"
          EXTRA_ARGS=""
          if [ -n "$PREID" ]; then
            EXTRA_ARGS="--preid=$PREID"
          fi
          yarn release "$SPEC" $EXTRA_ARGS

      - name: Push changes
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push origin HEAD
          git push origin --tags
